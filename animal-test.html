<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë™ë¬¼ìƒ í…ŒìŠ¤íŠ¸</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
</head>
<body>
    <button id="theme-toggle" aria-label="Toggle theme">ğŸŒ™</button>
    <a href="./index.html" class="lang-switch">ğŸ½ï¸ ë©”ë‰´ì¶”ì²œ</a>

    <div class="container animal-test-container">
        <h1>ğŸ¶ğŸ± ë™ë¬¼ìƒ í…ŒìŠ¤íŠ¸</h1>
        <p class="subtitle">ë‹¹ì‹ ì€ ê°•ì•„ì§€ìƒ? ê³ ì–‘ì´ìƒ?</p>

        <div id="webcam-container"></div>

        <div id="result-container" class="result-container" style="display: none;">
            <div id="result-emoji" class="result-emoji"></div>
            <div id="result-text" class="result-text"></div>
            <div id="result-description" class="result-description"></div>
        </div>

        <div id="label-container" class="label-container"></div>

        <button id="start-btn" onclick="init()">í…ŒìŠ¤íŠ¸ ì‹œì‘í•˜ê¸°</button>
        <button id="capture-btn" onclick="capture()" style="display: none;">ê²°ê³¼ í™•ì¸í•˜ê¸°</button>
        <button id="retry-btn" onclick="retry()" style="display: none;">ë‹¤ì‹œ í…ŒìŠ¤íŠ¸í•˜ê¸°</button>
    </div>

    <script>
        const URL = "https://teachablemachine.withgoogle.com/models/aWHbbmkoJ/";
        let model, webcam, labelContainer, maxPredictions;
        let isRunning = false;

        const themeToggle = document.getElementById('theme-toggle');
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        themeToggle.textContent = savedTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';

        themeToggle.addEventListener('click', () => {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            themeToggle.textContent = newTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
        });

        async function init() {
            document.getElementById('start-btn').style.display = 'none';
            document.getElementById('start-btn').textContent = 'ë¡œë”© ì¤‘...';

            const modelURL = URL + "model.json";
            const metadataURL = URL + "metadata.json";

            model = await tmImage.load(modelURL, metadataURL);
            maxPredictions = model.getTotalClasses();

            const flip = true;
            webcam = new tmImage.Webcam(280, 280, flip);
            await webcam.setup();
            await webcam.play();
            isRunning = true;
            window.requestAnimationFrame(loop);

            document.getElementById("webcam-container").appendChild(webcam.canvas);
            labelContainer = document.getElementById("label-container");

            for (let i = 0; i < maxPredictions; i++) {
                const div = document.createElement("div");
                div.className = "prediction-bar";
                labelContainer.appendChild(div);
            }

            document.getElementById('capture-btn').style.display = 'inline-block';
        }

        async function loop() {
            if (!isRunning) return;
            webcam.update();
            await predict();
            window.requestAnimationFrame(loop);
        }

        async function predict() {
            const prediction = await model.predict(webcam.canvas);
            for (let i = 0; i < maxPredictions; i++) {
                const percent = (prediction[i].probability * 100).toFixed(0);
                const className = prediction[i].className;
                const emoji = className.toLowerCase().includes('dog') || className === 'ê°•ì•„ì§€' ? 'ğŸ¶' : 'ğŸ±';
                labelContainer.childNodes[i].innerHTML = `
                    <span class="label-name">${emoji} ${className}</span>
                    <div class="bar-bg">
                        <div class="bar-fill" style="width: ${percent}%"></div>
                    </div>
                    <span class="label-percent">${percent}%</span>
                `;
            }
        }

        async function capture() {
            isRunning = false;
            webcam.stop();

            const prediction = await model.predict(webcam.canvas);
            let maxProb = 0;
            let resultClass = '';

            for (let i = 0; i < maxPredictions; i++) {
                if (prediction[i].probability > maxProb) {
                    maxProb = prediction[i].probability;
                    resultClass = prediction[i].className;
                }
            }

            const isDog = resultClass.toLowerCase().includes('dog') || resultClass === 'ê°•ì•„ì§€';
            const percent = (maxProb * 100).toFixed(0);

            document.getElementById('result-emoji').textContent = isDog ? 'ğŸ¶' : 'ğŸ±';
            document.getElementById('result-text').textContent = isDog ? 'ê°•ì•„ì§€ìƒ' : 'ê³ ì–‘ì´ìƒ';
            document.getElementById('result-description').innerHTML = isDog
                ? `<strong>${percent}%</strong> í™•ë¥ ë¡œ ê°•ì•„ì§€ìƒ!<br>ì¹œê·¼í•˜ê³  í™œë°œí•œ ë§¤ë ¥ì˜ ì†Œìœ ì`
                : `<strong>${percent}%</strong> í™•ë¥ ë¡œ ê³ ì–‘ì´ìƒ!<br>ë„ë„í•˜ê³  ì‹ ë¹„ë¡œìš´ ë§¤ë ¥ì˜ ì†Œìœ ì`;

            document.getElementById('result-container').style.display = 'block';
            document.getElementById('capture-btn').style.display = 'none';
            document.getElementById('retry-btn').style.display = 'inline-block';
            document.getElementById('label-container').style.display = 'none';
        }

        function retry() {
            document.getElementById('result-container').style.display = 'none';
            document.getElementById('retry-btn').style.display = 'none';
            document.getElementById('label-container').style.display = 'block';
            document.getElementById('capture-btn').style.display = 'inline-block';

            isRunning = true;
            webcam.play();
            window.requestAnimationFrame(loop);
        }
    </script>
</body>
</html>
