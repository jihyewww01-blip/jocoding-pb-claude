<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë™ë¬¼ìƒ í…ŒìŠ¤íŠ¸</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
</head>
<body>
    <button id="theme-toggle" aria-label="Toggle theme">ğŸŒ™</button>
    <a href="./index.html" class="lang-switch">ğŸ½ï¸ ë©”ë‰´ì¶”ì²œ</a>

    <div class="container animal-test-container">
        <h1>ğŸ¶ğŸ± ë™ë¬¼ìƒ í…ŒìŠ¤íŠ¸</h1>
        <p class="subtitle">ë‹¹ì‹ ì€ ê°•ì•„ì§€ìƒ? ê³ ì–‘ì´ìƒ?</p>

        <div id="image-container">
            <div id="upload-placeholder">
                <span>ğŸ“·</span>
                <p>ì‚¬ì§„ì„ ì„ íƒí•´ì£¼ì„¸ìš”</p>
            </div>
            <img id="preview-image" style="display: none;" />
        </div>

        <div id="result-container" class="result-container" style="display: none;">
            <div id="result-emoji" class="result-emoji"></div>
            <div id="result-text" class="result-text"></div>
            <div id="result-description" class="result-description"></div>
        </div>

        <div id="label-container" class="label-container"></div>

        <input type="file" id="file-input" accept="image/*" style="display: none;" onchange="handleFileSelect(event)">
        <button id="upload-btn" onclick="document.getElementById('file-input').click()">ì‚¬ì§„ ì„ íƒí•˜ê¸°</button>
        <button id="analyze-btn" onclick="analyze()" style="display: none;">ë¶„ì„í•˜ê¸°</button>
        <button id="retry-btn" onclick="retry()" style="display: none;">ë‹¤ë¥¸ ì‚¬ì§„ìœ¼ë¡œ í…ŒìŠ¤íŠ¸</button>
    </div>

    <script>
        const URL = "https://teachablemachine.withgoogle.com/models/aWHbbmkoJ/";
        let model, maxPredictions;
        let imageLoaded = false;

        const themeToggle = document.getElementById('theme-toggle');
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        themeToggle.textContent = savedTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';

        themeToggle.addEventListener('click', () => {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            themeToggle.textContent = newTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
        });

        async function loadModel() {
            const modelURL = URL + "model.json";
            const metadataURL = URL + "metadata.json";
            model = await tmImage.load(modelURL, metadataURL);
            maxPredictions = model.getTotalClasses();
        }

        loadModel();

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('preview-image');
                preview.src = e.target.result;
                preview.style.display = 'block';
                document.getElementById('upload-placeholder').style.display = 'none';
                document.getElementById('upload-btn').style.display = 'none';
                document.getElementById('analyze-btn').style.display = 'inline-block';
                document.getElementById('result-container').style.display = 'none';
                document.getElementById('label-container').innerHTML = '';
                imageLoaded = true;
            };
            reader.readAsDataURL(file);
        }

        async function analyze() {
            if (!model) {
                alert('ëª¨ë¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                return;
            }

            const image = document.getElementById('preview-image');
            const prediction = await model.predict(image);

            const labelContainer = document.getElementById('label-container');
            labelContainer.innerHTML = '';

            let maxProb = 0;
            let resultClass = '';

            for (let i = 0; i < maxPredictions; i++) {
                const percent = (prediction[i].probability * 100).toFixed(0);
                const className = prediction[i].className;
                const emoji = className.toLowerCase().includes('dog') || className === 'ê°•ì•„ì§€' ? 'ğŸ¶' : 'ğŸ±';

                const div = document.createElement('div');
                div.className = 'prediction-bar';
                div.innerHTML = `
                    <span class="label-name">${emoji} ${className}</span>
                    <div class="bar-bg">
                        <div class="bar-fill" style="width: ${percent}%"></div>
                    </div>
                    <span class="label-percent">${percent}%</span>
                `;
                labelContainer.appendChild(div);

                if (prediction[i].probability > maxProb) {
                    maxProb = prediction[i].probability;
                    resultClass = className;
                }
            }

            const isDog = resultClass.toLowerCase().includes('dog') || resultClass === 'ê°•ì•„ì§€';
            const percent = (maxProb * 100).toFixed(0);

            document.getElementById('result-emoji').textContent = isDog ? 'ğŸ¶' : 'ğŸ±';
            document.getElementById('result-text').textContent = isDog ? 'ê°•ì•„ì§€ìƒ' : 'ê³ ì–‘ì´ìƒ';
            document.getElementById('result-description').innerHTML = isDog
                ? `<strong>${percent}%</strong> í™•ë¥ ë¡œ ê°•ì•„ì§€ìƒ!<br>ì¹œê·¼í•˜ê³  í™œë°œí•œ ë§¤ë ¥ì˜ ì†Œìœ ì`
                : `<strong>${percent}%</strong> í™•ë¥ ë¡œ ê³ ì–‘ì´ìƒ!<br>ë„ë„í•˜ê³  ì‹ ë¹„ë¡œìš´ ë§¤ë ¥ì˜ ì†Œìœ ì`;

            document.getElementById('result-container').style.display = 'block';
            document.getElementById('analyze-btn').style.display = 'none';
            document.getElementById('retry-btn').style.display = 'inline-block';
        }

        function retry() {
            document.getElementById('file-input').value = '';
            document.getElementById('preview-image').style.display = 'none';
            document.getElementById('upload-placeholder').style.display = 'flex';
            document.getElementById('result-container').style.display = 'none';
            document.getElementById('label-container').innerHTML = '';
            document.getElementById('retry-btn').style.display = 'none';
            document.getElementById('analyze-btn').style.display = 'none';
            document.getElementById('upload-btn').style.display = 'inline-block';
            imageLoaded = false;
        }
    </script>
</body>
</html>
